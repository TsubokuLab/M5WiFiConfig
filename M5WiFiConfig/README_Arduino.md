# M5Stack WiFi設定システム - Arduino IDE版

## 📁 フォルダ構成

```
M5WiFiConfig/
├── M5WiFiConfig.ino    # メインスケッチファイル
├── config.h            # 設定ファイル（カスタマイズ用）
├── styles.h            # スタイル定義ファイル
└── README_Arduino.md   # このファイル
```

## 🚀 使用方法

### **ステップ1: Arduino IDEで開く**
- `M5WiFiConfig.ino` ファイルをArduino IDEで開いてください
- 他のファイル（config.h, styles.h）も自動的にタブで表示されます

### **ステップ2: ライブラリのインストール**
以下のライブラリがインストールされていることを確認してください：
- **M5Unified** (by M5Stack) - 最新版推奨
- WiFi (ESP32標準 - 自動でインストールされます)
- WebServer (ESP32標準 - 自動でインストールされます)
- DNSServer (ESP32標準 - 自動でインストールされます)
- Preferences (ESP32標準 - 自動でインストールされます)
- ESPmDNS (ESP32標準 - 自動でインストールされます)

### **ステップ3: ボード設定**
- ツール → ボード → ESP32 Arduino → **M5Stack-Core2** を選択
- ツール → ポート → 適切なCOMポートを選択

### **ステップ4: カスタマイズ（任意）**
`config.h` タブでアプリケーションをカスタマイズできます：

#### **基本設定**
```cpp
#define APP_TITLE "WiFi設定サンプル"                    // アプリタイトル
#define AP_SSID "Device-Setup"                         // アクセスポイント名
#define AP_PASS "12345678"                             // アクセスポイントパスワード
#define AUTHOR_NAME "YourName"                         // 作者名
```

#### **WiFi監視設定**
```cpp
#define WIFI_CONNECTION_TIMEOUT 20                     // 接続タイムアウト
#define WIFI_CHECK_INTERVAL 5000                       // 監視間隔（5秒）
#define WIFI_RECONNECT_ATTEMPTS 10                     // 再接続試行回数
```

#### **カラーテーマ**
4つのWebUIテーマから選択可能：
1. **ブルー・パープル（デフォルト）** - そのまま使用
2. **グリーン・ティール** - 該当部分のコメントアウトを解除
3. **オレンジ・レッド** - 該当部分のコメントアウトを解除  
4. **ピンク・パープル** - 該当部分のコメントアウトを解除

### **ステップ5: コンパイル・アップロード**
- 検証ボタン（✓）でコンパイルエラーがないことを確認
- アップロードボタン（→）でM5Stackに書き込み

## 🎯 動作説明

### **3つの動作モード**

#### **1. セットアップモード（SETUP_MODE）**
WiFi設定が未保存の場合に自動起動
- M5Stackがアクセスポイントになります（デフォルト: Device-Setup）
- **QRコードスキャン**でWiFi接続・設定画面アクセスが可能
- **キャプティブポータル**で自動リダイレクト
- **Ajax対応ネットワーク更新**ボタン付きの設定画面

#### **2. アプリモード（APP_MODE）**
WiFi接続成功後のメイン画面
- カスタマイズ可能なアプリケーション画面
- リアルタイム接続状態表示（点滅LED）
- 設定画面への切り替え機能

#### **3. 設定モード（SETTING_MODE）**
アプリモードから切り替え可能な詳細設定画面
- WiFi接続状況の詳細表示
- Web設定ページへのQRコードアクセス
- 再起動・初期化機能

### **操作方法**

#### **タッチスクリーン操作（推奨）**
| 画面モード | 左ボタン | 中央ボタン | 右ボタン |
|-----------|---------|-----------|---------|
| **アプリモード** | 設定画面へ | --- | --- |
| **設定モード** | アプリに戻る | 再起動 | 初期化 |
| **セットアップモード** | --- | --- | --- |

#### **物理ボタン操作**
- **ボタンA**: 左ボタンと同じ機能
- **ボタンB**: 中央ボタンと同じ機能
- **ボタンC**: 右ボタンと同じ機能

#### **状態表示**
- **接続LED**: WiFi接続状態を視覚的に表示
- **点滅インジケーター**: 画面右上の接続状態アイコン
- **リアルタイム監視**: 5秒間隔で接続状態チェック

### **WebUI機能**

#### **WiFi設定ページの特徴**
- **ネットワーク更新ボタン**: 🔄ボタンでリアルタイム更新
- **Ajax通信**: ページリロード不要
- **暗号化表示**: 🔒（WPA）・🔓（オープン）マーク
- **信号強度**: dBm表示で電波品質確認
- **レスポンシブデザイン**: スマホ・PC対応UI

#### **設定完了画面**
- **自動再起動**: 設定保存後の自動処理
- **閉じるボタン**: ブラウザ画面の手動終了
- **進捗表示**: 視覚的なフィードバック

## 🎨 特徴

### **高機能UI**
- **3モード画面**: 用途別に最適化されたUI
- **色分けヘッダー**: 赤（セットアップ）・緑（アプリ）・紫（設定）
- **QRコード接続**: WiFi接続・Web設定への直接アクセス
- **日本語フォント**: 美しい日本語表示対応
- **タッチフィードバック**: 直感的な操作感

### **堅牢なWiFi管理**
- **自動再接続**: 切断検出時の自動復旧（最大10回）
- **接続監視**: 5秒間隔での定期チェック
- **状態可視化**: リアルタイム接続状況表示
- **障害時自動復旧**: 再接続失敗時の自動再起動

### **モダンなWebUI**
- **Ajax更新**: スムーズなネットワーク更新
- **エラーハンドリング**: 通信エラー時の適切な処理
- **キャプティブポータル**: 自動設定画面転送
- **レスポンシブ**: デバイス問わず最適表示

### **開発者フレンドリー**
- **モジュール設計**: config.h・styles.hでの簡単カスタマイズ
- **詳細ログ**: デバッグ用シリアル出力
- **拡張性**: アプリ画面の自由なカスタマイズ

## 🔧 トラブルシューティング

### **コンパイルエラー**
- **M5Unifiedライブラリ**がインストールされているか確認（最新版推奨）
- ボード設定が**M5Stack-Core2**になっているか確認
- 他のM5Stack機種ではタッチスクリーンが動作しない場合あり

### **WiFi接続エラー**
- パスワードが正しいか確認
- 2.4GHz帯のWiFiに接続（5GHz非対応）
- 設定画面の「🔄 更新」ボタンで最新ネットワーク情報を取得

### **Webページ表示エラー**
- **セットアップモード**: QRコードスキャンまたは `192.168.4.1` に直接アクセス
- **アプリモード**: M5Stackに表示されるIPアドレスにアクセス
- キャプティブポータルが動作しない場合は、ブラウザでDNSキャッシュをクリア

### **操作が反応しない**
- タッチスクリーンの場合：画面最下部のボタンエリアを正確にタッチ
- 物理ボタンが優先：M5.BtnA/B/Cでの操作を試行
- 画面フリーズ時：右ボタン（再起動）で復旧

### **接続が不安定**
- 電波強度を確認（設定画面でdBm値チェック）
- WiFiルーターとの距離を確認
- 再接続回数が上限に達した場合は自動再起動

## 📝 開発者向け情報

### **ファイル構成**
- **M5WiFiConfig.ino**: メインロジック・3モード制御
- **config.h**: 全設定項目（ユーザーカスタマイズ用）
- **styles.h**: WebUI生成・CSS・HTML構築

### **主要関数**
- `setup()`: 初期化・モード判定・画面表示
- `drawDisplay()`: モード別画面描画の統括
- `drawMainPage()` / `drawSetupPage()` / `drawSettingsPage()`: 各モード専用画面
- `updateNetworkList()`: WiFiスキャン・リスト生成
- `updateConnectionStatusDisplay()`: 接続状態の視覚的更新

### **カスタマイズポイント**
- **アプリ画面**: `drawMainPage()`関数内で自由にUI作成
- **色設定**: config.hの各COLOR定義で画面色をカスタマイズ
- **動作タイミング**: WIFI_CHECK_INTERVALで監視頻度調整
- **再接続回数**: WIFI_RECONNECT_ATTEMPTSで安定性チューニング

### **使用技術**
- **M5Unified API**: 最新のM5Stack統合ライブラリ
- **ESP32 WiFi**: 接続管理・スキャン・アクセスポイント
- **WebServer + DNSServer**: キャプティブポータル実装
- **MDNS**: ローカルドメイン対応（device.local）
- **Preferences**: 不揮発性設定保存
- **Ajax + JSON**: リアルタイムWebUI更新

### **拡張例**
```cpp
// アプリ画面のカスタマイズ例（drawMainPage関数内）
M5.Display.drawString("温度: " + String(temperature) + "℃", itemX, itemY);
M5.Display.drawString("湿度: " + String(humidity) + "%", itemX, itemY + 20);
// センサーデータ表示、時計表示、グラフ描画など自由に実装可能
```

## 🎊 総評

このプロジェクトは**商用レベルのIoTデバイス管理システム**として：

- ✅ **プロダクションレディ**: そのまま製品に組み込み可能
- ✅ **ユーザーフレンドリー**: 直感的な3モードUI
- ✅ **開発者フレンドリー**: 簡単カスタマイズ・豊富なログ
- ✅ **堅牢性**: 自動復旧・エラーハンドリング完備
- ✅ **モダン**: Ajax・レスポンシブ・QRコード対応

M5Stack WiFi設定システムの**決定版**として、あらゆる用途に対応できる完成度の高いシステムです！